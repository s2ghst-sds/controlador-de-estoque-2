<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StockCtrl - Gestão de Estoque</title>
  <link rel="stylesheet" href="/css/ctrl.css">
</head>

<body>
  <div class="container">
    <header>
      <h1>StockCtrl - Gestão de Estoque</h1>
      <nav>
        <a href="/">Início</a>
        <a href="/ctrl">Controle de Estoque</a>
        <a href="/login">Login</a>
        <a href="/register">Registrar</a>
      </nav>
    </header>

    <main>
      <section class="form-section">
        <h2>Adicionar Novo Produto</h2>

        <div class="form-group">
          <input id="nome" placeholder="Nome do produto" required />
        </div>

        <div class="form-group">
          <textarea id="desc" placeholder="Descrição do produto" rows="2" required></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <input id="precocompra" placeholder="Preço de compra" type="number" step="0.01" required />
          </div>

          <div class="form-group">
            <input id="precovenda" placeholder="Preço de venda" type="number" step="0.01" required />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <input id="validade" placeholder="Validade" type="date" />
          </div>

          <div class="form-group">
            <input id="qntd" placeholder="Quantidade em estoque" type="number" required />
          </div>
        </div>

        <div class="form-group">
          <input id="qntdmin" placeholder="Quantidade minima de estoque" type="number" />
        </div>
  


  <div class="form-group">
    <select id="categoria" required>
      <option value="">Selecione uma categoria</option>
      <option value="Chá">Chá</option>
      <option value="Caneca">Caneca</option>
      <option value="Garrafa">Garrafa</option>
      <option value="Infusor">Infusor</option>
      <option value="Acessório">Acessório</option>
      <option value="Outros">Outros</option>
    </select>
  </div>

  <div class="image-upload">
    <h3>Imagem do Produto (Obrigatório)</h3>
    <input type="file" id="imagemInput" accept="image/*" onchange="previewImage(this)" required />
    <div class="image-preview">
      <img id="imagePreview" class="hidden" width="200" />
    </div>
  </div>

  <div class="form-actions">
    <button class="btn btn-add" onclick="addProd()">Adicionar Produto</button>
    <button class="btn btn-toggle" onclick="toggleLista()">Mostrar/Ocultar Lista</button>
  </div>
  </section>

  <section class="list-section">
    <ul id="lista-produtos" class="hidden"></ul>
  </section>
  </main>
  </div>

  <div id="notification" class="notification hidden"></div>
  </div>

  <script src="/js/main.js"></script>
  <script>
    // ENDPOINTS DA API - usando caminhos relativos
    const API_PRODUTOS = "/produtos";
    const API_UPLOAD = "/uploads";

    let listaVisivel = false;
    let currentImageFile = null;

    // Função para mostrar notificação
    function showNotification(message, type) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type} show`;

      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // Função para visualizar a imagem antes do upload
    function previewImage(input) {
      const preview = document.getElementById('imagePreview');
      currentImageFile = input.files[0];

      if (currentImageFile) {
        const reader = new FileReader();

        reader.onload = function (e) {
          preview.src = e.target.result;
          preview.classList.remove('hidden');
        }

        reader.readAsDataURL(currentImageFile);
      } else {
        preview.src = '';
        preview.classList.add('hidden');
      }
    }

    // Alternar visibilidade da lista
    function toggleLista() {
      listaVisivel = !listaVisivel;
      const lista = document.getElementById('lista-produtos');
      lista.classList.toggle('hidden', !listaVisivel);

      if (listaVisivel) {
        allProd();
      }
    }

    // Adicionar produto
    async function addProd() {
      const nome = document.getElementById("nome").value;
      const desc = document.getElementById("desc").value;
      const precocompra = parseFloat(document.getElementById("precocompra").value);
      const precovenda = parseFloat(document.getElementById("precovenda").value);
      const validade = document.getElementById("validade").value;
      const qntd = parseInt(document.getElementById("qntd").value);
      const qntdmin = parseInt(document.getElementById("qntdmin").value);
      const categoria = document.getElementById("categoria").value;

      if (!nome || !desc || !precocompra || !precovenda || !qntd || !categoria || !currentImageFile) {
        showNotification('Por favor, preencha todos os campos obrigatórios!', 'error');
        return;
      }

      // Criar FormData para enviar tanto os dados do produto quanto a imagem
      const formData = new FormData();
      formData.append('nome', nome);
      formData.append('desc', desc);
      formData.append('categoria', categoria);
      formData.append('precocompra', precocompra);
      formData.append('precovenda', precovenda);
      formData.append('validade', validade);
      formData.append('qntd', qntd);
      formData.append('qntdmin', qntdmin);
      formData.append('file', currentImageFile);

      try {
        const response = await fetch(API_PRODUTOS, {
          method: "POST",
          body: formData
        });

        if (response.ok) {
          const produtoCriado = await response.json();
          showNotification('Produto adicionado com sucesso!', 'success');

          // Limpar campos
          document.getElementById("nome").value = "";
          document.getElementById("desc").value = "";
          document.getElementById("precocompra").value = "";
          document.getElementById("precovenda").value = "";
          document.getElementById("validade").value = "";
          document.getElementById("qntd").value = "";
          document.getElementById("qntdmin").value = "";
          document.getElementById("categoria").value = "";
          document.getElementById("imagemInput").value = "";
          document.getElementById("imagePreview").classList.add('hidden');
          currentImageFile = null;

          // Atualizar a lista se estiver visível
          if (listaVisivel) {
            allProd();
          }
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('Erro ao adicionar produto:', response.status, errorData);
          showNotification('Erro ao adicionar produto. Verifique os dados.', 'error');
        }
      } catch (error) {
        console.error('Erro de conexão:', error);
        showNotification('Erro de conexão ao adicionar produto', 'error');
      }
    }

    // Remover produto
    async function removeProd(id, nome) {
      if (!confirm(`Tem certeza que deseja remover o produto "${nome}"?`)) {
        return;
      }

      try {
        const response = await fetch(`${API_PRODUTOS}/${id}`, { method: "DELETE" });
        if (response.ok) {
          showNotification('Produto removido com sucesso!', 'success');
          allProd(); // Atualiza a lista
        } else {
          showNotification('Erro ao remover produto', 'error');
        }
      } catch (error) {
        console.error('Erro:', error);
        showNotification('Erro ao remover produto', 'error');
      }
    }

    // Iniciar edição de produto
    function startEditProd(id) {
      // Encontrar o produto na lista
      const productElement = document.getElementById(`product-${id}`);
      const productDetails = productElement.querySelector('.product-details');
      const editForm = productElement.querySelector('.edit-form');

      // Preencher o formulário com os dados atuais
      const nome = productElement.querySelector('[data-field="nome"]').textContent;
      const desc = productElement.querySelector('[data-field="desc"]').textContent;
      const precocompra = productElement.querySelector('[data-field="precocompra"]').textContent;
      const precovenda = productElement.querySelector('[data-field="precovenda"]').textContent;
      const validadeValue = productElement.querySelector('[data-field="validade"]').dataset.value;
      const qntd = productElement.querySelector('[data-field="qntd"]').textContent;
      const qntdmin = productElement.querySelector('[data-field="qntdmin"]').textContent;
      const categoria = productElement.querySelector('[data-field="categoria"]').textContent;

      editForm.querySelector('#edit-nome').value = nome;
      editForm.querySelector('#edit-desc').value = desc;
      editForm.querySelector('#edit-precocompra').value = precocompra;
      editForm.querySelector('#edit-precovenda').value = precovenda;
      editForm.querySelector('#edit-validade').value = validadeValue || '';
      editForm.querySelector('#edit-qntd').value = qntd;
      editForm.querySelector('#edit-qntdmin').value = qntdmin;
      editForm.querySelector('#edit-categoria').value = categoria;

      // Alternar visibilidade
      productDetails.classList.add('hidden');
      editForm.classList.remove('hidden');
    }

    // Cancelar edição
    function cancelEdit(id) {
      const productElement = document.getElementById(`product-${id}`);
      const productDetails = productElement.querySelector('.product-details');
      const editForm = productElement.querySelector('.edit-form');

      productDetails.classList.remove('hidden');
      editForm.classList.add('hidden');
    }

    // Salvar edição do produto
    async function saveEdit(id) {
      const nome = document.querySelector(`#product-${id} #edit-nome`).value;
      const desc = document.querySelector(`#product-${id} #edit-desc`).value;
      const precocompra = parseFloat(document.querySelector(`#product-${id} #edit-precocompra`).value);
      const precovenda = parseFloat(document.querySelector(`#product-${id} #edit-precovenda`).value);
      const validade = document.querySelector(`#product-${id} #edit-validade`).value;
      const qntd = parseInt(document.querySelector(`#product-${id} #edit-qntd`).value);
      const qntdmin = parseInt(document.querySelector(`#product-${id} #edit-qntdmin`).value);
      const categoria = document.querySelector(`#product-${id} #edit-categoria`).value;

      if (!nome || !desc || !precocompra || !precovenda || !qntd || !categoria) {
        showNotification('Por favor, preencha todos os campos obrigatórios!', 'error');
        return;
      }

      const produtoData = {
        nome,
        desc,
        categoria,
        precocompra,
        precovenda,
        validade,
        qntd,
        qntdmin
      };

      try {
        const response = await fetch(`${API_PRODUTOS}/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(produtoData)
        });

        if (response.ok) {
          showNotification('Produto atualizado com sucesso!', 'success');
          allProd(); // Atualiza a lista
        } else {
          showNotification('Erro ao atualizar produto', 'error');
        }
      } catch (error) {
        console.error('Erro:', error);
        showNotification('Erro ao atualizar produto', 'error');
      }
    }

    // Função auxiliar para formatar data de forma segura
    function safeDateFormat(dateString) {
      if (!dateString) return 'Não definida';

      try {
        const datePart = dateString.split('T')[0];
        const date = new Date(datePart);
        return date.toLocaleDateString('pt-BR');
      } catch (e) {
        console.error('Erro ao formatar data:', e);
        return 'Data inválida';
      }
    }

    // Função auxiliar para extrair valor da data de forma segura
    function safeDateValue(dateString) {
      if (!dateString) return '';

      try {
        return dateString.split('T')[0];
      } catch (e) {
        console.error('Erro ao extrair valor da data:', e);
        return '';
      }
    }

    // Listar todos os produtos
    async function allProd() {
      try {
        const response = await fetch(API_PRODUTOS);
        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }

        const produtos = await response.json();
        console.log('Produtos recebidos:', produtos); // Para debug

        const lista = document.getElementById('lista-produtos');
        lista.innerHTML = ''; // Limpa a lista

        produtos.forEach(produto => {
          // Verificar se o produto tem imagem
          const hasImage = produto.imagem && produto.imagem.src;
          const imageUrl = hasImage ? `/${produto.imagem.src}` : '';

          // Extrair valor da data de forma segura
          const dataValor = safeDateValue(produto.validade);
          const dataFormatada = safeDateFormat(produto.validade);

          lista.innerHTML += `
            <li id="product-${produto._id}">
              <div class="product-details">
                <p><strong>Produto:</strong> <span data-field="nome">${produto.nome}</span></p>
                <p><strong>Descrição:</strong> <span data-field="desc">${produto.desc || 'Nenhuma'}</span></p>
                <p><strong>Categoria:</strong> <span data-field="categoria">${produto.categoria}</span></p>
                <p><strong>Preço de compra:</strong> R$ <span data-field="precocompra">${produto.precocompra}</span></p>
                <p><strong>Preço de venda:</strong> R$ <span data-field="precovenda">${produto.precovenda}</span></p>
                <p><strong>Validade:</strong> <span data-field="validade" data-value="${dataValor}">${dataFormatada}</span></p>
                <p><strong>Quantidade em estoque:</strong> <span data-field="qntd">${produto.qntd}</span></p>
                <p><strong>Quantidade mínima em estoque:</strong> <span data-field="qntdmin">${produto.qntdmin || 'Não definida'}</span></p>
                
                ${hasImage ? `
                  <div class="image-container">
                    <strong>Imagem:</strong> 
                    <img src="${imageUrl}" alt="${produto.nome}" class="product-image" 
                         onerror="console.error('Erro ao carregar imagem:', this.src); this.style.display='none'"/>
                  </div>
                ` : '<p><strong>Imagem:</strong> Nenhuma imagem disponível</p>'}
                
                <div class="product-actions">
                  <button class="btn btn-edit" onclick="startEditProd('${produto._id}')">Editar</button>
                  <button class="btn btn-remove" onclick="removeProd('${produto._id}', '${produto.nome}')">Remover</button>
                </div>
              </div>
              
              <div class="edit-form hidden">
                <h3>Editar Produto</h3>
                <input type="text" id="edit-nome" placeholder="Nome" value="${produto.nome}">
                <textarea id="edit-desc" placeholder="Descrição" rows="2">${produto.desc || ''}</textarea>
                <input type="number" id="edit-precocompra" placeholder="Preço de compra" step="0.01" value="${produto.precocompra}">
                <input type="number" id="edit-precovenda" placeholder="Preço de venda" step="0.01" value="${produto.precovenda}">
                <input type="date" id="edit-validade" value="${dataValor}">
                <input type="number" id="edit-qntd" placeholder="Quantidade" value="${produto.qntd}">
                <input type="number" id="edit-qntdmin" placeholder="Quantidade minima de estoque" value="${produto.qntdmin || ''}">
                <select id="edit-categoria">
                  <option value="Chá" ${produto.categoria === 'Chá' ? 'selected' : ''}>Chá</option>
                  <option value="Caneca" ${produto.categoria === 'Caneca' ? 'selected' : ''}>Caneca</option>
                  <option value="Garrafa" ${produto.categoria === 'Garrafa' ? 'selected' : ''}>Garrafa</option>
                  <option value="Infusor" ${produto.categoria === 'Infusor' ? 'selected' : ''}>Infusor</option>
                  <option value="Acessório" ${produto.categoria === 'Acessório' ? 'selected' : ''}>Acessório</option>
                  <option value="Outros" ${produto.categoria === 'Outros' ? 'selected' : ''}>Outros</option>
                </select>
                
                <div class="product-actions">
                  <button class="btn btn-add" onclick="saveEdit('${produto._id}')">Salvar</button>
                  <button class="btn btn-remove" onclick="cancelEdit('${produto._id}')">Cancelar</button>
                </div>
              </div>
            </li>
          `;
        });
      } catch (error) {
        console.error('Erro ao carregar produtos:', error);
        showNotification('Erro ao carregar produtos. Verifique a conexão com a API.', 'error');
      }
    }

    // Inicialização quando a página carrega
    document.addEventListener('DOMContentLoaded', function () {
      // Verificar se o usuário está autenticado
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login';
        return;
      }

      // Carregar produtos se a lista estiver visível
      if (listaVisivel) {
        allProd();
      }
    });
  </script>
</body>

</html>